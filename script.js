// Translations
const translations = {
    en: {
        nav: {
            home: "Home",
            about: "About us",
            services: "Services",
            partners: "Our Partners",
            contact: "Contact us"
        },
        hero: {
            networks: "Networks.",
            communications: "Communications.",
            security: "Security.",
            subtitle: "Technological solutions for private and corporate clients.",
            experience: "Experience",
            products: "Products",
            projects: "Projects Done",
            consultation: "Get Consultation"
        },
        services: {
            title: "Our Services",
            networking: {
                title: "Networking & Cybersecurity",
                description: "Professional network infrastructure and cybersecurity solutions"
            },
            security: {
                title: "Video Surveillance (CCTV)",
                description: "Professional CCTV and video surveillance solutions for comprehensive security monitoring"
            },
            monitoring: {
                title: "Access Control Systems",
                description: "Smart locks, card readers, and mobile app management"
            },
            support: {
                title: "Intrusion & Alarm Systems",
                description: "Motion detectors, panic buttons, and 24/7 security monitoring"
            }
        },
        about: {
            title: "About Us",
            description: "SubNet Group is a leading technology company specializing in comprehensive IT solutions. We provide cutting-edge network infrastructure, robust security systems, and reliable communication solutions for businesses of all sizes.",
            feature1: "Professional Team",
            feature2: "24/7 Support",
            feature3: "Proven Results",
            why_choose: "Why Choose Us"
        },
        process: {
            title: "Our Working Process",
            subtitle: "Professional approach to every project with guaranteed results",
            discussion: "Discussion",
            discussion_desc: "Understanding your needs and requirements",
            installation: "Installation",
            installation_desc: "Professional implementation and setup",
            maintenance: "Maintenance",
            maintenance_desc: "Ongoing support and optimization"
        },
        partners: {
            title: "Our Partners",
            subtitle: "We work with industry-leading technology partners to deliver comprehensive solutions"
        },
        contact: {
            title: "Contact Us",
            phone: "Phone",
            email: "E-Mail",
            name: "Name",
            email_address: "Email address",
            phone_number: "Phone number",
            message: "Message",
            send_message: "Send Message",
            verify_human: "I'm not a robot",
            email_or_phone_required: "Please provide either email or phone number"
        },
        footer: {
            description: "Installation, configuration and maintenance of access control systems, computer networks and other modern systems",
            navigation: "Navigation"
        },
        common: {
            learn_more: "Learn More"
        },

        certifications: {
            title: "Certifications & Achievements",
            iso: "Information Security Management",
            cissp: "Certified Information Systems Security Professional",
            ccnp: "Cisco Certified Network Professional and Associate - Advanced networking and routing protocols expertise",
            microsoft: "Ruckus Certification Program"
        },
        stats: {
            projects: "Projects Completed",
            clients: "Happy Clients",
            devices: "Devices Managed",
            uptime: "% Uptime Guaranteed"
        }
    },
    he: {
        nav: {
            home: "בית",
            about: "אודותינו",
            services: "שירותים",
            partners: "השותפים שלנו",
            contact: "צור קשר"
        },
        hero: {
            networks: "רשתות.",
            communications: "תקשורת.",
            security: "אבטחה.",
            subtitle: "פתרונות טכנולוגיים ללקוחות פרטיים ועסקיים.",
            experience: "ניסיון",
            products: "מוצרים",
            projects: "פרויקטים שהושלמו",
            consultation: "קבל יעוץ"
        },
        services: {
            title: "השירותים שלנו",
            networking: {
                title: "רשתות ואבטחת מידע",
                description: "פתרונות תשתית רשת מקצועית ואבטחת מידע"
            },
            security: {
                title: "מערכות מעקב וידאו (CCTV)",
                description: "פתרונות מעקב וידאו ו-CCTV מקצועיים לניטור אבטחה מקיף"
            },
            monitoring: {
                title: "מערכות בקרת כניסה",
                description: "מנעולים חכמים, קוראי כרטיסים וניהול אפליקציות נייד"
            },
            support: {
                title: "מערכות אזעקה והתראה",
                description: "גלאי תנועה, כפתורי חירום וניטור אבטחה 24/7"
            }
        },
        about: {
            title: "אודותינו",
            description: "SubNet Group היא חברת טכנולוגיה מובילה המתמחה בפתרונות IT מקיפים. אנו מספקים תשתית רשת חדישה, מערכות אבטחה חזקות ופתרונות תקשורת אמינים לעסקים בכל הגדלים.",
            feature1: "צוות מקצועי",
            feature2: "תמיכה 24/7",
            feature3: "תוצאות מוכחות",
            why_choose: "למה לבחור בנו"
        },
        process: {
            title: "תהליך העבודה שלנו",
            subtitle: "גישה מקצועית לכל פרויקט עם תוצאות מובטחות",
            discussion: "דיון",
            discussion_desc: "הבנת הצרכים והדרישות שלכם",
            installation: "התקנה",
            installation_desc: "יישום והגדרה מקצועית",
            maintenance: "תחזוקה",
            maintenance_desc: "תמיכה מתמשכת ואופטימיזציה"
        },
        partners: {
            title: "השותפים שלנו",
            subtitle: "אנו עובדים עם שותפי טכנולוגיה מובילים בתעשייה כדי לספק פתרונות מקיפים"
        },
        contact: {
            title: "צור קשר",
            phone: "טלפון",
            email: "אימייל",
            name: "שם",
            email_address: "כתובת אימייל",
            phone_number: "מספר טלפון",
            message: "הודעה",
            send_message: "שלח הודעה",
            verify_human: "אני לא רובוט",
            email_or_phone_required: "אנא ספק אימייל או מספר טלפון"
        },
        footer: {
            description: "התקנה, תצורה ותחזוקה של מערכות בקרת גישה, רשתות מחשבים ומערכות מודרניות אחרות",
            navigation: "ניווט"
        },
        common: {
            learn_more: "למד עוד"
        },

        certifications: {
            title: "הסמכות והישגים",
            iso: "ניהול אבטחת מידע",
            cissp: "מומחה מוסמך לאבטחת מערכות מידע",
            ccnp: "הסמכת רשתות סיסקו מקצועית ובסיסית - מומחיות מתקדמת ברשתות ופרוטוקולי ניתוב",
            microsoft: "Ruckus Certification Program"
        },
        stats: {
            projects: "פרויקטים שהושלמו",
            clients: "לקוחות מרוצים",
            devices: "מכשירים מנוהלים",
            uptime: "% זמינות מובטחת"
        }
    }
};

// Global variables
let currentLanguage = 'he';

// DOM Elements
const loadingScreen = document.getElementById('loading-screen');

// Loading Screen Animation
window.addEventListener('load', () => {
    setTimeout(() => {
        document.body.classList.add('loaded');
        setTimeout(() => {
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
        }, 500);
    }, 3000); // Show loading for 3 seconds
});

// Language Switcher
function updateLanguage(lang) {
    currentLanguage = lang;
    // СОХРАНЯЕМ ЯЗЫК В LOCALSTORAGE ДЛЯ СЕРВИСОВ!
    localStorage.setItem('preferred-language', lang);
    console.log('Saved language to localStorage:', lang); // DEBUG
    
    // Update all translated elements
    const elements = document.querySelectorAll('[data-translate]');
    elements.forEach(element => {
        const key = element.getAttribute('data-translate');
        const translation = getNestedTranslation(translations[lang], key);
        if (translation) {
            element.textContent = translation;
        }
    });
    
    // Update placeholder texts
    const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
    placeholderElements.forEach(element => {
        const key = element.getAttribute('data-translate-placeholder');
        const translation = getNestedTranslation(translations[lang], key);
        if (translation) {
            element.placeholder = translation;
        }
    });
    
    // Update HTML lang and direction attributes
    document.documentElement.lang = lang;
    document.documentElement.dir = lang === 'he' ? 'rtl' : 'ltr';
    document.body.className = lang === 'he' ? 'rtl-mode' : 'ltr-mode';
    
    // Force RTL contact form if mobile
    if (window.innerWidth <= 768) {
        setTimeout(forceRTLContactForm, 100);
    }
}

function getNestedTranslation(obj, path) {
    return path.split('.').reduce((current, key) => current && current[key], obj);
}

// Smooth Scrolling for Navigation Links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            const headerOffset = 80;
            const elementPosition = target.getBoundingClientPosition().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }
    });
});

// Header Scroll Effect
window.addEventListener('scroll', () => {
    const header = document.querySelector('.header');
    if (header) {
        if (window.scrollY > 100) {
            header.style.background = 'rgba(15, 20, 25, 0.98)';
            header.style.backdropFilter = 'blur(15px)';
        } else {
            header.style.background = 'rgba(15, 20, 25, 0.95)';
            header.style.backdropFilter = 'blur(10px)';
        }
    }
});

// Intersection Observer for Animations
const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
};

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('visible');
        }
    });
}, observerOptions);

// Observe elements for animation
document.addEventListener('DOMContentLoaded', () => {
    // Initialize with Hebrew by default
    if (!isServicePage()) {
        updateLanguage('he');
        // Set Hebrew button as active
        const heBtn = document.querySelector('.lang-btn[data-lang="he"]');
        if (heBtn) {
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            heBtn.classList.add('active');
        }
    }
    
    // --- Обработчики для стандартных кнопок смены языка (desktop) ---
    document.querySelectorAll('.language-switcher .lang-btn').forEach(btn => {
      btn.onclick = () => {
        const lang = btn.dataset.lang;
        if (!isServicePage()) {
          updateLanguage(lang);
        }
        document.querySelectorAll('.language-switcher .lang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // На страницах сервисов используем их собственный переключатель языков - НЕ ВЫЗЫВАЕМ из script.js
        // Убрано: window.ServicePageComponents.LanguageSwitcher().applyTranslations(lang) - это стирало флаги!
      };
    });

    // --- Новый фиксированный гамбургер и offcanvas меню для ГЛАВНОЙ СТРАНИЦЫ ---
    if (!isServicePage()) {
      const fixedHamburger = document.getElementById('fixedHamburger');
      const overlay = document.getElementById('menuOverlay');
      const offcanvas = document.getElementById('offcanvasMenu');
      if (fixedHamburger && overlay && offcanvas) {
        function closeMenu() {
          fixedHamburger.classList.remove('active');
          offcanvas.classList.remove('active');
          overlay.classList.remove('active');
          document.body.style.overflow = '';
        }
        function openMenu() {
          fixedHamburger.classList.add('active');
          offcanvas.classList.add('active');
          overlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
        fixedHamburger.onclick = () => {
          if (offcanvas.classList.contains('active')) closeMenu();
          else openMenu();
        };
        overlay.onclick = closeMenu;
        // Закрытие по клику на ссылку
        const menuNav = offcanvas.querySelector('.menu-nav');
        if (menuNav) {
          menuNav.querySelectorAll('a').forEach(link => {
            link.onclick = closeMenu;
          });
        }
        // Закрытие по Esc
        document.addEventListener('keydown', e => {
          if (e.key === 'Escape') closeMenu();
        });
        // Языки внутри меню
        const menuLangs = offcanvas.querySelector('.menu-langs');
        if (menuLangs) {
          menuLangs.querySelectorAll('.lang-btn').forEach(btn => {
            btn.onclick = () => {
              const lang = btn.dataset.lang;
              updateLanguage(lang);
              menuLangs.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
            };
          });
        }
      }
    }

    // --- Animated counter for statistics (работает на всех страницах) ---
    function animateCounter(element, target) {
        const duration = 2000; // 2 seconds
        const steps = 60;
        const increment = target / steps;
        let current = 0;
        
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            
            if (target === 99.9) {
                element.textContent = current.toFixed(1);
            } else {
                element.textContent = Math.floor(current).toLocaleString();
            }
        }, duration / steps);
    }

    const statsObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            console.log('Stats intersection:', entry.isIntersecting, entry.target);
            if (entry.isIntersecting) {
                const statNumbers = entry.target.querySelectorAll('.stat-number');
                console.log('Found stat numbers:', statNumbers.length);
                statNumbers.forEach(statNumber => {
                    const target = parseFloat(statNumber.dataset.number);
                    console.log('Animating:', statNumber, 'to target:', target);
                    animateCounter(statNumber, target);
                });
                statsObserver.unobserve(entry.target);
            }
        });
    }, { threshold: 0.5 });

    // Initialize stats observer with delay to ensure DOM is ready
    setTimeout(() => {
        document.querySelectorAll('.stats-grid').forEach(grid => {
            console.log('Observing stats grid:', grid);
            statsObserver.observe(grid);
        });
    }, 500);

    // ANCHOR LINK NAVIGATION FIX
    class AnchorNavigation {
        constructor() {
            this.init();
        }

        init() {
            this.handleHashOnLoad();
            this.smoothScrollToAnchors();
        }

        handleHashOnLoad() {
            // Проверяем есть ли хеш в URL при загрузке страницы
            window.addEventListener('load', () => {
                const hash = window.location.hash;
                if (hash) {
                    // Небольшая задержка чтобы страница полностью загрузилась
                    setTimeout(() => {
                        this.scrollToElement(hash);
                    }, 300);
                }
            });

            // Также обрабатываем если пользователь пришел по прямой ссылке
            document.addEventListener('DOMContentLoaded', () => {
                const hash = window.location.hash;
                if (hash) {
                    setTimeout(() => {
                        this.scrollToElement(hash);
                    }, 500);
                }
            });
        }

        scrollToElement(hash) {
            const element = document.querySelector(hash);
            if (element) {
                // Учитываем высоту хедера
                const headerHeight = document.querySelector('.header')?.offsetHeight || 70;
                const elementPosition = element.getBoundingClientRect().top + window.pageYOffset;
                const offsetPosition = elementPosition - headerHeight - 20;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });

                // Обновляем URL без перезагрузки
                history.replaceState(null, null, hash);
            }
        }

        smoothScrollToAnchors() {
            // Обрабатываем клики по якорным ссылкам на текущей странице
            document.addEventListener('click', (e) => {
                const link = e.target.closest('a[href^="#"]');
                if (link) {
                    e.preventDefault();
                    const hash = link.getAttribute('href');
                    this.scrollToElement(hash);
                }
            });
        }
    }

    // NAVIGATION IMPROVEMENTS
    class NavigationEnhancer {
        constructor() {
            this.init();
        }

        init() {
            this.highlightActiveSection();
            this.improveNavigationUX();
        }

        highlightActiveSection() {
            const sections = document.querySelectorAll('section[id]');
            const navLinks = document.querySelectorAll('.nav-menu a[href^="#"]');

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('id');
                        
                        // Убираем активный класс со всех ссылок
                        navLinks.forEach(link => link.classList.remove('active'));
                        
                        // Добавляем активный класс к текущей ссылке
                        const activeLink = document.querySelector(`.nav-menu a[href="#${id}"]`);
                        if (activeLink) {
                            activeLink.classList.add('active');
                        }
                    }
                });
            }, {
                rootMargin: '-100px 0px -100px 0px',
                threshold: 0.1
            });

            sections.forEach(section => {
                observer.observe(section);
            });
        }

        improveNavigationUX() {
            // Добавляем эффекты для логотипа
            const logo = document.querySelector('.logo');
            if (logo) {
                logo.addEventListener('click', (e) => {
                    // Если мы уже на главной странице, прокручиваем вверх
                    if (window.location.pathname.endsWith('index.html') || window.location.pathname === '/') {
                        e.preventDefault();
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                    }
                });
            }

            // Добавляем прелоадер эффект при переходах между страницами
            const externalLinks = document.querySelectorAll('a[href^="../"], a[href^="services/"], a[href="index.html"]');
            externalLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    // Добавляем эффект загрузки
                    document.body.style.opacity = '0.8';
                    document.body.style.transition = 'opacity 0.3s ease';
                });
            });
        }
    }

    // PREMIUM SCROLL ANIMATIONS SYSTEM
    class ScrollAnimations {
        constructor() {
            this.animatedElements = [];
            this.init();
        }

        init() {
            this.addAnimationClasses();
            this.observeElements();
            this.addStaggeredAnimations();
        }

        addAnimationClasses() {
            // Add animation classes to elements
            const animations = [
                { selector: '.services h2, .partners h2, .about h2, .contact h2, .certifications h2', class: 'fade-in-up', delay: 0 },
                { selector: '.services .section-subtitle, .partners .section-subtitle, .about .section-subtitle', class: 'fade-in-up', delay: 0.2 },
                { selector: '.service-card', class: 'slide-in-up', delay: 'staggered' },
                { selector: '.partner-card', class: 'scale-in', delay: 'staggered' },
                { selector: '.contact-info, .contact-form', class: 'slide-in-up', delay: 'staggered' },
                { selector: '.contact-item', class: 'slide-in-left', delay: 'staggered' },
                { selector: '.social-link', class: 'rotate-in', delay: 'staggered' },
                { selector: '.certification-card', class: 'flip-in', delay: 'staggered' },
                { selector: '.hero-subtitle, .hero-description', class: 'fade-in-up', delay: 0.3 }
            ];

            animations.forEach(anim => {
                const elements = document.querySelectorAll(anim.selector);
                elements.forEach((el, index) => {
                    el.classList.add(anim.class);
                    if (anim.delay === 'staggered') {
                        el.style.animationDelay = `${index * 0.1}s`;
                    } else {
                        el.style.animationDelay = `${anim.delay}s`;
                    }
                });
            });
        }

        observeElements() {
            const options = {
                root: null,
                rootMargin: '-5% 0px -5% 0px',
                threshold: 0.1
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !entry.target.classList.contains('animated')) {
                        this.animateElement(entry.target);
                    }
                });
            }, options);

            // Observe all animation elements
            const animatedElements = document.querySelectorAll('.fade-in-up, .slide-in-up, .slide-in-left, .slide-in-right, .scale-in, .rotate-in, .flip-in');
            animatedElements.forEach(el => {
                observer.observe(el);
            });
        }

        animateElement(element) {
            element.classList.add('animated');
            
            // Add shimmer effect to titles
            if (element.tagName === 'H2' && element.querySelector('::after')) {
                setTimeout(() => {
                    element.style.transform = 'translateY(0)';
                }, 300);
            }
        }

        addStaggeredAnimations() {
            // Add enhanced staggered animations for card grids
            const cardContainers = [
                { selector: '.services-grid', childSelector: '.service-card' },
                { selector: '.partners-grid', childSelector: '.partner-card' },
                { selector: '.certifications-grid', childSelector: '.certification-card' }
            ];

            cardContainers.forEach(container => {
                const parent = document.querySelector(container.selector);
                if (parent) {
                    const cards = parent.querySelectorAll(container.childSelector);
                    cards.forEach((card, index) => {
                        const delay = index * 0.1 + 0.2;
                        card.style.animationDelay = `${delay}s`;
                    });
                }
            });
        }
    }

    new AnchorNavigation();
    new NavigationEnhancer();

    // Set initial language
    updateLanguage(currentLanguage);
    
    // FORCE RTL FOR CONTACT FORM ON MOBILE
    if (window.innerWidth <= 768) {
        forceRTLContactForm();
    }
    
    window.addEventListener('resize', () => {
        if (window.innerWidth <= 768) {
            forceRTLContactForm();
        }
    });

    // Add loading class to body initially
    document.body.classList.add('loading');

    // Initialize scroll animations
    new ScrollAnimations();

    console.log('SubNet Group website initialized successfully!');
});

function isServicePage() {
  return window.location.pathname.includes('/services/');
}

// ULTIMATE RTL FORCE FOR CONTACT FORM
function forceRTLContactForm() {
    console.log('forceRTLContactForm called, currentLanguage:', currentLanguage);
    
    if (currentLanguage === 'he') {
        // Force contact form inputs to RTL with maximum specificity
        const contactInputs = document.querySelectorAll('.contact-form input, .contact-form textarea');
        console.log('Found contact form inputs:', contactInputs.length);
        
        contactInputs.forEach((input, index) => {
            console.log(`Setting ULTIMATE RTL for contact input ${index}:`, input);
            input.style.setProperty('text-align', 'right', 'important');
            input.style.setProperty('direction', 'rtl', 'important');
            input.style.setProperty('unicode-bidi', 'bidi-override', 'important');
            input.setAttribute('dir', 'rtl');
            
            // Force placeholder RTL too
            if (input.placeholder) {
                input.style.setProperty('text-align', 'right', 'important');
            }
        });
        
        // Force verification checkbox
        const checkbox = document.querySelector('.verification-checkbox');
        if (checkbox) {
            console.log('Forcing checkbox RTL');
            checkbox.style.setProperty('flex-direction', 'row-reverse', 'important');
            checkbox.style.setProperty('text-align', 'right', 'important');
            checkbox.style.setProperty('direction', 'rtl', 'important');
            
            const checkmark = checkbox.querySelector('.checkmark');
            if (checkmark) {
                checkmark.style.setProperty('margin-right', '0', 'important');
                checkmark.style.setProperty('margin-left', '10px', 'important');
            }
        }
        
        console.log('ULTIMATE Contact form RTL force completed');
    }
} 